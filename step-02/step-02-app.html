<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="local-signaling-channel.html">

<link rel="import" href="bower_components/rtc-web-components/rtc-data-channel.html">
<link rel="import" href="bower_components/rtc-web-components/rtc-media-stream.html">
<link rel="import" href="bower_components/rtc-web-components/rtc-peer-connection.html">

<dom-module id="step-02-app">
  <template>
    <style>
      :host {
        font-family: sans-serif;
      }

      video {
        max-width: 100%;
        width: 320px;
      }
    </style>

    <local-signaling-channel instance={{_signalingChannel}}></local-signaling-channel>

    <rtc-peer-connection id="one" peer="two" signaling=[[_signalingChannel]]>
        <rtc-media-stream in=[[_mediaStream]]></rtc-media-stream>
    </rtc-peer-connection>

    <rtc-peer-connection id="two" peer="one" signaling=[[_signalingChannel]]>
        <rtc-media-stream out={{_remoteStream}}></rtc-media-stream>
    </rtc-peer-connection>

    <h1>Realtime communication with WebRTC</h1>

    <video id="localVideo" src-object=[[_localStream]] autoplay></video>
    <video id="remoteVideo" src-object=[[_remoteStream]] autoplay></video>

    <div>
      <button id="startButton" on-click="start">Start</button>
      <button id="callButton"  on-click="call" disabled>Call</button>
      <button id="hangupButton" on-click="hangup" disabled>Hang Up</button>
    </div>
  </template>

  <script>
    class Step02App extends Polymer.Element {
      static get is() {
        return 'step-02-app';
      }

      start() {
        this.$.startButton.disabled = true;
        navigator.mediaDevices.getUserMedia({
            audio: false,
            video: true
        })
        .then(stream => {
          this.$.callButton.disabled = false;
          this._localStream = stream;
        })
        .catch(function(e) {
            alert('getUserMedia() error: ' + e.name);
        });
      }

      call() {
        this.$.callButton.disabled = true;
        this.$.hangupButton.disabled = false;
        this._mediaStream = this._localStream;
      }

      hangup() {
        // this.$.one._pc.close();
        this.$.two._pc.close();
        // this._mediaStream = undefined;
        this.$.hangupButton.disabled = true;
        this.$.callButton.disabled = false;
      }
    }

    customElements.define(Step02App.is, Step02App);
  </script>
</dom-module>
